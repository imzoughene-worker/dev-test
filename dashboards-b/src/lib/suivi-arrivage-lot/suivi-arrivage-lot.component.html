<div class="grid grid-cols-1 gap-4">
  <kendo-card
    width="100%"
    [formGroup]="suiviArrivageService.formFilter">
    @if ((editMode$ | async) === false) {
    <kendo-card-body class="grid grid-cols-6 content-center">
      <h6
        kendoCardTitle
        class="m-0 col-span-2 flex items-center">
        Dashboard Suivi Arrivage Lot - {{ getTitle | async }}
      </h6>
      <kendo-card-actions
        class="col-span-4"
        [layout]="'end'">
        <portals-auto-refresher
          [initialValue]="false"
          (refreshTriggered)="search()"></portals-auto-refresher>
        <div class="k-form-field">
          @if ({ val: handleDateChange | async }; as val) {
          <kendo-daterange>
            <kendo-label text="Début">
              <kendo-dateinput
                kendoDateRangeStartInput
                formControlName="startingDate"></kendo-dateinput>
            </kendo-label>
            <kendo-label text="Fin">
              <kendo-dateinput
                kendoDateRangeEndInput
                formControlName="endDate"></kendo-dateinput>
            </kendo-label>
          </kendo-daterange>
          }
        </div>
        <button
          kendoButton
          [svgIcon]="filterIcon"
          (click)="toggleFilters()"></button>
        <button
          kendoButton
          [svgIcon]="pencilIcon"
          (click)="setEditMode(true)"></button>
        <button
          kendoButton
          [fillMode]="'solid'"
          [svgIcon]="arrowRotateCwIcon"
          (click)="search()"></button>
      </kendo-card-actions>
    </kendo-card-body>
    } @else {
    <kendo-card-body class="flex justify-center gap-2 items-center">
      <span
        kendoCardSubtitle
        class="m-0">
        Déplacez ou redimensionnez vos widgets, puis terminez la modification.</span
      >
      <button
        kendoButton
        (click)="setEditMode(false)"
        [themeColor]="'primary'">
        Terminer la modification
      </button>
    </kendo-card-body>
    } @if (filterOpen$ | async) {
    <kendo-card-footer class="flex flex-nowrap justify-between gap-4 items-center">
      <div class="flex gap-4 items-center flex-wrap">
        <portals-dashboard-search-field
          class="min-w-[250px]"
          [field]="souscripteurField"></portals-dashboard-search-field>
        @if(suiviArrivageService.filterForToday.getValue() || trigramme.authority !== 'EBM') {
        <portals-dashboard-search-field
          class="min-w-[250px]"
          [field]="policeField"></portals-dashboard-search-field>
        }
        <portals-dashboard-search-field
          class="min-w-[250px]"
          [field]="numeroLotField"></portals-dashboard-search-field>
        @if (isInterne || appMode()?.isCompanyMode) {
        <portals-dashboard-search-field
          class="min-w-[250px]"
          [field]="totalSaisieField"></portals-dashboard-search-field>
        } @if (isInterne || appMode()?.isCompanyMode) {
        <portals-dashboard-search-field
          class="min-w-[250px]"
          [field]="ecartField"></portals-dashboard-search-field>
        } @if (isInterne || appMode()?.isCompanyMode) {
        <portals-dashboard-search-field
          class="min-w-[250px]"
          [field]="etatLotField"></portals-dashboard-search-field>
        }
        <kendo-card-actions [layout]="'start'">
          <span class="margin-filter">
            Filtrer sur Aujourd'hui
            <kendo-switch
              [checked]="(suiviArrivageService.filterForToday | async) ?? false"
              (valueChange)="suiviArrivageService.filterForToday.next($event)">
            </kendo-switch>
          </span>
        </kendo-card-actions>
        @if(trigramme.authority === 'EBM') {
        <kendo-card-actions layout="start">
          <span class="margin-filter">
            Filtrer sur la police du lot
            <kendo-svgicon
              kendoTooltip
              title="Le filtre sur la police fonctionne uniquement pour les lots d’arrivage dont les dossiers ont déjà commencé la saisie."
              [icon]="infoCircleIcon"></kendo-svgicon>
          </span>
          <kendo-switch
            [checked]="(suiviArrivageService.filterByPolice | async) ?? false"
            (valueChange)="suiviArrivageService.filterByPolice.next($event)">
          </kendo-switch>
        </kendo-card-actions>
        } @if(trigramme.authority === 'AZM') {
        <kendo-card-actions layout="start">
          <span class="margin-filter">
            Dossiers NextCare
            <kendo-svgicon
              kendoTooltip
              title="Activer ce filtre pour afficher uniquement les données liées à Nextcare."
              [icon]="infoCircleIcon"></kendo-svgicon>
          </span>
          <kendo-switch
            [checked]="(suiviArrivageService.filterByNextcare | async) ?? false"
            (valueChange)="suiviArrivageService.filterByNextcare.next($event)">
          </kendo-switch>
        </kendo-card-actions>
        }
      </div>
      <kendo-card-actions
        class=""
        [layout]="'end'">
        <button
          kendoButton
          (click)="reset()">
          Réinitialiser
        </button>
        <button
          kendoButton
          (click)="search()">
          Appliquer
        </button>
      </kendo-card-actions>
    </kendo-card-footer>
    }
  </kendo-card>
  <router-outlet (activate)="onOutletLoaded($event, editModeSignal())"></router-outlet>
</div>
